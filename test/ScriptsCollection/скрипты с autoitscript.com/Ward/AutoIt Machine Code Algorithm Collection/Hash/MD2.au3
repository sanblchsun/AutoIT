; -----------------------------------------------------------------------------
; MD2 Hash Machine Code UDF
; Purpose: Provide The Machine Code Version of MD2 Hash Algorithm In AutoIt
; Author: Ward
; -----------------------------------------------------------------------------

#Include-once
#Include <Memory.au3>

Global $_MD2_CodeBuffer, $_MD2_CodeBufferMemory
Global $_MD2_InitOffset, $_MD2_InputOffset, $_MD2_ResultOffset

Global $_HASH_MD2[4] = [16, 212, '_MD2_', '_MD2_']

Func _MD2_Exit()
	$_MD2_CodeBuffer = 0
	_MemVirtualFree($_MD2_CodeBufferMemory, 0, $MEM_RELEASE)
EndFunc

Func _MD2_Startup()
	If Not IsDllStruct($_MD2_CodeBuffer) Then
		If @AutoItX64 Then
			Local $Opcode = '0x89DBE98A00000087DBE91A01000009DBE9B1000000534989CA4889CB488D49104889D80FB650408850203250108850304883C0014839C875EAE8830100004C8D4B304531DB31C04889DA0FB6C0410FB604003242108842104883C2014C39CA75E94183FB1174094401D84183C301EBD70FB6430F413242400FB6C0410FB604004132024188024983C2014C39D175E55BC3F6C10457BAD40000004889CF751989D131C0C1E90383E20489C9F348AB7406C707000000005FC3C701000000004883C704B2D0EBD9564889D6534889CB4883EC288B81D0000000B91000000028C183F80F7F0F4863D083C00183F810884C134075F14889D9E81AFFFFFF488B034889D948894340488B430848894348E803FFFFFF488B4310488906488B4318488946084883C4285B5EC3415641554154554889D5574889CF56534489C34883EC204585C07E6B4C8D694041BE10000000EB3289DE31DB4863C94C63E64889EA498D4C0D004D89E0E85C01000003B7D000000083FE1089B7D0000000741E85DB7E304C01E58B8FD00000008D040B83F8107EC04489F629CE29F3EBBBC787D0000000000000004889F9E86AFEFFFF85DB7FD04883C4205B5E5F5D415C415D415EC34158C3E8F8FFFFFF292E43C9A2D87C013D3654A1ECF0061362A705F3C0C7738C98932BD9BC4C82CA1E9B573CFDD4E01667426F188A17E512BE4EC4D6DA9EDE49A0FBF58EBB2FEE7AA968799115B2073F94C210890B225F21807F5D9A5A903227353ECCE7BFF79703FF1930B348A5B5D1D75E922AAC56AAC64FB838D296A47DB676FC6BE29C7404F1459D705964718720865BCF65E62DA8021B6025ADAEB0B9F61C46616934407E0F5547A323DD51AF3AC35CF9CEBAC5EA262C530D6E85288409D3DFCDF441814D526ADC37C86CC1ABFA24E17B080CBDB14A7888958BE363E86DE9CBD5FE3B001D39F2EFB70E6658D0E4A67772F8EB754B0A314450B48FED1F1ADB998D339F11831456574889CF4889D64C89C1FCF3A45F5EC3574889CF4889D04C89C1FCF3AA5FC3'
		Else
			Local $Opcode = '0x89DB83EC048B442408890424E8C100000083C404C2100087DB83EC1C8B442428894424088B442424894424048B442420890424E81E01000083C41CC2100009DB83EC1C8B442424894424048B442420890424E88D00000083C41CC21000565389C383EC04E87601000031D20FB64C1340884C1320324C1310884C133083C20183FA1075E731F631D231C90FB6D20FB6141032540B1088540B1083C10183F93075E983FE11740701F283C601EBDB0FB64B0F31D2324C13400FB6C90FB60C08320C13880C1383C20183FA1075E783C4045B5EC3578B542408B93500000031C089D7F3AB5FC356B910000000538B5C240C8B7424108B83D000000028C183F80F7F118D54034083C001880A83C20183F81075F389D8E845FFFFFF8B138D43408953408B53048950048B53088950088B530C89500C89D8E824FFFFFF8B53108D431089168B50048956048B50088956088B400C89460C5B5EC35557565383EC2C8B7424488B7C24408B6C244485F67E688D47408944241CEB3189F331F60344241C895C2408896C2404890424E8560100008B87D000000001D883F8108987D0000000741F85F67E3001DD8B87D00000008D140683FA107EC1BB1000000029C329DEEBBAC787D00000000000000089F8E88CFEFFFF85F67FD083C42C5B5E5F5DC358C3E8F9FFFFFF292E43C9A2D87C013D3654A1ECF0061362A705F3C0C7738C98932BD9BC4C82CA1E9B573CFDD4E01667426F188A17E512BE4EC4D6DA9EDE49A0FBF58EBB2FEE7AA968799115B2073F94C210890B225F21807F5D9A5A903227353ECCE7BFF79703FF1930B348A5B5D1D75E922AAC56AAC64FB838D296A47DB676FC6BE29C7404F1459D705964718720865BCF65E62DA8021B6025ADAEB0B9F61C46616934407E0F5547A323DD51AF3AC35CF9CEBAC5EA262C530D6E85288409D3DFCDF441814D526ADC37C86CC1ABFA24E17B080CBDB14A7888958BE363E86DE9CBD5FE3B001D39F2EFB70E6658D0E4A67772F8EB754B0A314450B48FED1F1ADB998D339F11831456578B7C240C8B7424108B4C241485C9742FFC83F9087227F7C7010000007402A449F7C702000000740566A583E90289CAC1E902F3A589D183E103F3A4EB02F3A45F5EC3'
		EndIf
		$_MD2_InitOffset = (StringInStr($Opcode, "89DB") - 3) / 2
		$_MD2_InputOffset = (StringInStr($Opcode, "87DB") - 3) / 2
		$_MD2_ResultOffset = (StringInStr($Opcode, "09DB") - 3) / 2
		$Opcode = Binary($Opcode)

		$_MD2_CodeBufferMemory = _MemVirtualAlloc(0, BinaryLen($Opcode), $MEM_COMMIT, $PAGE_EXECUTE_READWRITE)
		$_MD2_CodeBuffer = DllStructCreate("byte[" & BinaryLen($Opcode) & "]", $_MD2_CodeBufferMemory)
		DllStructSetData($_MD2_CodeBuffer, 1, $Opcode)
		OnAutoItExitRegister("_MD2_Exit")
	EndIf
EndFunc

Func _MD2Init()
	If Not IsDllStruct($_MD2_CodeBuffer) Then _MD2_Startup()

	Local $Context = DllStructCreate("byte[" & $_HASH_MD2[1] & "]")
	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_MD2_CodeBuffer) + $_MD2_InitOffset, _
													"ptr", DllStructGetPtr($Context), _
													"int", 0, _
													"int", 0, _
													"int", 0)

	Return $Context
EndFunc

Func _MD2Input(ByRef $Context, $Data)
	If Not IsDllStruct($_MD2_CodeBuffer) Then _MD2_Startup()
	If Not IsDllStruct($Context) Then Return SetError(1, 0, 0)

	$Data = Binary($Data)
	Local $InputLen = BinaryLen($Data)
	Local $Input = DllStructCreate("byte[" & $InputLen & "]")
	DllStructSetData($Input, 1, $Data)
	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_MD2_CodeBuffer) + $_MD2_InputOffset, _
													"ptr", DllStructGetPtr($Context), _
													"ptr", DllStructGetPtr($Input), _
													"uint", $InputLen, _
													"int", 0)
EndFunc

Func _MD2Result(ByRef $Context)
	If Not IsDllStruct($_MD2_CodeBuffer) Then _MD2_Startup()
	If Not IsDllStruct($Context) Then Return SetError(1, 0, "")

	Local $Digest = DllStructCreate("byte[" & $_HASH_MD2[0] & "]")
	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_MD2_CodeBuffer) + $_MD2_ResultOffset, _
													"ptr", DllStructGetPtr($Context), _
													"ptr", DllStructGetPtr($Digest), _
													"int", 0, _
													"int", 0)
	Return DllStructGetData($Digest, 1)
EndFunc

Func _MD2($Data)
	Local $Context = _MD2Init()
	_MD2Input($Context, $Data)
	Return _MD2Result($Context)
EndFunc
