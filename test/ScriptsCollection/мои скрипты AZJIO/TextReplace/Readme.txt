
TextReplace - поиск и замена текста в любых файлах. Поддержка сценариев замены и регулярных выражений, ком-строки.

Символ переноса строк - простой способ без регулярных выражений выполнить поиск и замену многострочного текста. В качестве переноса строк выбирается символ, которого нет в тексте поиска и замены, и указываем перенос строк с помощью этого символа в полях ввода поиска и замены. При использовании двойного символа, например ~| происходит подмена символов CR и LF индивидуально для каждого, в случае, если в тексте перенос строки осуществляется одним символом, как в UNIX (LF) или MAC (CR). Использование двойного одинакового символа, например ~~ заменяется на одинарный и обрабатывается как ~, поэтому не имеет смысла.

Сценарий замены можно создать средствами TextReplace, но можно открыть в блокноте и вручную вставить образцы поиска и замены, разделяя параметры комбинацией символов }—•—{ и с указанием начала командной строки -->| и конца |<-- смотрите готовые примеры. Каждая командная строка сценария состоит строго из 13 параметров и начинается с новой строки и заканчивается переносом строки. Любое несоответствие игнорируется. Это значит вы можете оставлять комментарии между командными строками, а в параметрах поиска и замены использовать многострочный текст. Перед использованием сценария происходит предпросмотр, поэтому ошибки ручной правки сценария можно увидеть предпросмотром. Некоторые параметры имеют два значения 0 или 1, что равносильно "Нет" и "Да". Все параметры присутствуют в интерфейсе программы и при добавлении новой командной строки в сценарий считываются текущие установки. Перед выполнением сценария проверяются существование путей поиска указанных в сценарии. Если хотя бы один путь не существует операция будет отменена с выводом сообщения об ошибке. Эконом режим включается, если в сценарии одинаковы путь, маска, исключения, уровень вложения, атрибуты, кодировка. В эконом-режиме файл открывается один раз и в цикле производятся все замены, в противоположность полному режиму, где один и тот же файл может открыться более одного раза для однократной замены. Эконом режим может значительно увеличить скорость операции при обработке одних и тех же файлов по сценарию.

Для каждого элемента интерфейса есть подсказка. Окно программы поддерживает drag-and-drop, то есть достаточно кинуть папку, файл, сценарий и программа добавит их в соответствующие поля ввода. Возможно на Win7 не будет работать drag-and-drop (будет исправлено позже).

Резервные копии создаются по умолчанию в папке программы, в папке Backup, если в настройках не указана другая. При каждой новой операции с резервированием создаётся каталог, в имени которого указывается текущее время и имя папки в которой происходит замена. Внутри резервного каталога создаются копии с сохранением структуры каталогов. Если каталог сохранения по какой то причине не доступен, например нет диска, на котором должна быть создана папка резервных копий или нет доступа для записи, то программа предупредит о невозможности резервирования и предложит отменить действие или продолжить без резервирования.

При замене текста появляется список файлов, напротив которых указано число замен. Если это число равно 0, то файл возможно открыт в другой программе и для замены нет доступа, или диск не доступен для записи. При поиске текста напротив файлов указывается позиция символа, в которой найдено первое совпадение, последующие совпадения уже не проверяются. Строка состояния показывает объём файлов, количество файлов, номер текущего обрабатываемого файла, количество текущих совпадений и относительный путь текущего обрабатываемого файла. При работе сценария дополнительно указывается количество командных строк и номер текущей обрабатываемой командной строки. В экономном режиме обработки сценария указывается "Econ".

В настройках добавлена опция ограничения объёма и количества файлов, при которых выдаётся предупреждение. Предупреждение можно игнорировать, но всё же поможет предотвратить ошибку при операции с большим объёмом данных. А также присутствует возможность отмены уже начатой операции с помощью горячей клавишей Esc.

Кнопка вывода результата в режиме поиска позволяет отображать все найденные искомые образцы в каждом файле, а не только проверка наличия первого совпадения. В результатах возвращается строка с добавлением 40 символов до и после найденного образца. Иногда это работает медленнее, но только при множестве файлов, большого количества совпадений и с использованием регулярных выражений. Поэтому режим вывода результата рекомендуется. Результат выводится при клике на пункте списка (используйте "стрелка вниз" для удобного просмотра), при клике на том же пункте повторно вывод результата отключается/включается, это сделано для удобства управления. Отключение кнопкой - принудительно отключает результаты, несмотря на то что они есть. При поиске с отключенными результатами выполняется только проверка первого совпадения и для текущих результатов не будет возможности включить просмотр результатов. При использовании регулярного выражения результат в первой строке содержит найденный образец, во второй - строка с найденным образцом.

Используйте режим Auto (рекомендуется) при выборе способа открытия и сохранения файлов, чтобы поиск и замена выполнялись в любой кодировке и сохранялись в той же кодировке, в которой сам файл был прежде. В остальных режимах, если кодировка файла не соответствует указанной, то файл игнорируется. То есть, если поиск выполняется с выбором кодировки UTF-8 (+BOM), то файлы в кодировке ANSI, UTF16 и UTF-8 (-BOM) будут игнорироваться.

Поддерживаются параметры:
не учитывать регистр, регулярное выражение
Путь, маска, исключения, вложенность
делать резервные копии
Восстановление даты изменения
Игнорировать файлы хотя бы с одним из указанных атрибутов

В ком-строке поддерживаются следующие ключи:
/s"Search" - строка поиска
/r"Replace" - строка замены
/a - независимо от регистра
/e - регулярное выражение
/w"~|" - символы заменяющие перенос строки @CRLF.
Если один или два одинаковых символа, то аналогично @CRLF, а если два разных символа, то первый символ заменяет CR, второй LF
/b - делать бэкап изменяемых файлов
/b"PathBackUp" - ключ или ключ с путём
/p"Path" - путь поиска
/m"Mask" - маска
/i - исключение для маски, то есть все кроме указанных в маске
/l"Level" - уровень вложения
/d - восстанавливать прежнюю дату
/t"RAHS" - файл, содержащий хотя бы один из указанных в параметре атрибутов будет проигнорирован и не будет участвовать в операции замены.
/f"U8" - кодировка по умолчанию Auto, иначе указанная ANSI, U8, U8B, U16L, U16B, Bin.
/z"MaxFileSize" - Максимальный размер обрабатываемых файлов в байтах. По умолчанию 180 Мб для избежания ошибки памяти

Пример ком-строки
"D:\folder\TextReplace.exe" \s"Text" \r"New Text" \p"D:\test" \m"*.inf|*.ini" /b
"D:\folder\TextReplace.exe" \s"String~|NewString" \r"New Text" /w"~|" \p"D:\test" \m"*.inf|*.ini" /b
"D:\folder\TextReplace.exe" \s"(\r\n|\r|\n){2,}" \r"\1" \p"D:\test" \m"test.au3" /b /e
"D:\folder\TextReplace.exe" \s"\d+" \r"number" /e \p"D:\test" \m"*.inf|*.ini" /b \l0

Коды возвращаемых ошибок:
1 - не указана строка поиска
2 - не указана строка замены
3 - не указан путь
4 - не верно указана резервная папка
5 - не удачный поиск файлов
6 - строка поиска и замены одинаковы

ключи ком-строки могут быть в любой комбинации в любом порядке, главное требование - обязательные три параметра шаблон поиска, шаблон замены, путь поиска.

Ограничение: при открытии файла размером более ~190 Мб ошибка "Error allocating memory." - Ошибка выделения памяти. Всвязи с этим добавлена возможность пропуска таких файлов. Для бинарного чтения файлов этот параметр может быть увеличен до ~350Мб

Обновления

Отмена поиска/замены сопровождается выводом результатов на момент остановки.

1.1
Добавлена возможность вместо пути к обрабатываемым файлам указать список файлов.
Добавлен расширеный экспорт списка результатов, в том числе в файл для последующего использования поиска или замены
Добавлена проверка правильности регулярного выражения, перед тем как начать поиск или замену
Закрытие окон по ESC запрещён
Запуск внешних au3-скриптов используя программу запрещён
Добавлен вывод общего числа замен
Курсор автоматически встаёт на первый элемент в списке результатов
При добавлении командной строки в сценарий замены проверяется наличие в списке аналогичной строки
Увеличены начальные размеры окон для вставки многострочных текстов поиска и замены.
Исправлен размер раскрывающегося списка в окне просмотра результатов
Исправлено при добавлении командной строки в сценарий замены параметр восстановления времени и атрибуты не сбрасываются в ноль
Переход на версию компиляции 3.3.8.1, добавление x64, отключение  использования UPX

1.0
Окно многострочного текста с возможностью изменения размера
Добавлен экспорт списка файлов в буфер обмена
Теперь не учитывает регистр в именах файлов с русскими буквами для русской локализации
Изменён механизм перетащить и бросить (WM_DROPFILES).
Если в маске "*", то перетаскивании файлов маска заменяется, а не добавляется.
После поиска или замены список найденных файлов (ListBox) получает фокус (сразу клавишей "стрелка вниз" выполнять просмотр)
Уменьшено мерцание окна
Улучшено поведение окна (сохраняется высота списка результатов, работает кнопка "развернуть на весь экран")
Добавлена возможность пропуска файлов более указанного размера. По умолчанию 180 Мб для предотвращения ошибок памяти

0.9
Кнопка "Отправить в буфер обмена" заменена на "Просмотр результатов поиска". Интерактивный RichEdit с подсветкой найденного.
Добавлена замена нечитаемых символов пустышкой, при этом просмотрщик не обрезает результаты на нечитаемых символах
_FileSearch.au3 заменена на FileOperations.au3 (не влияющие внутри скриптовые перестановки)
Исправлен случай когда текст не является одинаковым при разном регистре букв в полях поиска и замены
Добавлен режим Auto в настройках кодировки и сделан по умолчанию
В режимах кодировки поиск и замена выполняется только при условии соответствия указанной кодировки

0.8
Добавлены две кнопки для вставки многострочного текста и автоподстановки символов переноса строки
Добавлены 3 горячие клавиши (Alt+s - поиск, Alt+e - открыть в проводнике, Ctrl+Enter - вставка переноса строки)
Добавлена кнопка "вывод результата" только в режиме поиска (создаёт всплывающую подсказку с результатами поиска при клике на пункте)
Добавлена кнопка отправки результата поиска в буфер обмена
Добавлена кнопка и пункт конт. меню "В проводнике" для быстрого перехода к выделенному в списке файлу
Исправлено, теперь, при не выделенном элементе списка кнопка "открыть" не приводит к открытию всех документов в папке
При выборе регулярного выражения кнопка учёта регистра деактивируется
При очистки строк курсор фокусируется в поле ввода
Временно удалён диалог запроса на перезапись файла при добавлении команды сценария
Добавлена справка в виде CHM
Исправлено создание резервных копий для всех функций при указании пути в настройках
ком-строка независима от регистра параметров
Добавлен выбор кодировки ANSI, UTF, бинарный

0.7
Для ком-строки добавлены коды ошибок, если операция замены произошла неудачно
Изменён формат сценариев *.srt, который содержит параметры замены для каждой команды сценария
Добавлена экономичная функция для сценария, которая при одинаковых параметрах списка файлов делает замены за один проход
Добавлены параметры "восстановление даты изменения" и игнорирование замен в файлах с указанными атрибутами
Исправлено замена в файлах с атрибутами RSH, которое не работало.

0.6
Обработка событий изменена на OnEvent
Добавлены настройки
Изменена функция поиска файлов (поддерживается полная маска файлов, а не только тип)
Изменен способ обновления раскрывающихся списков
Добавлена поддержка ком-строки
Отмена поиска не сопровождается завершением программы
Показывает объём обрабатываемых данных
Если файл "Только для чтения" то в результатах отображается количество замен равно 0, несмотря на то что текст найден.
Формат lng изменился, для защиты внутренних переменных
В ini изменился разделитель параметров

0.5
Добавлены иконки кнопкам
Добавлено ограничение окна по ширине.
Обновлён диалог "О программе"
Кнопка "Обзор" учитывает введённый путь в поле ввода.

0.4
Разделитель сменил на ¤, для возможности сохранения патернов с символами |
Добавил спец-символы в список символов переноса строк
Исправил сохранение ini.
Добавил кнопку "Открыть+F".
Компилировал на версии 3.3.6.1.


TextReplace.dll - нужна только для нескомпилированного скрипта, для отображения иконок.

Благодарю snoitaleR за советы и тест утилиты.

В планах:
1. Для ком-строки добавить параметр "подпапки". Добавить параметр вывода сообщений об ошибках с разным уровнем подробностей. Возможно поиск в ком-строке с выводом результатов в файл. Возможно экономный режим замены с возможностью указания пар параметров /s и /r, которые будут получены в массив для пакетной обработки за один проход.
2. Для Gui-интерфейса добавить кнопку для открытия дочернего окна с возможностью ввода многострочного текста и поиском оного. Аналогично для замены окно с двумя полями Edit.

Учитывайте, что при замене бинарных данных допустимые символы тоже бинарные: от 0 до 9 и от A до F при этом чётное количество симвлов в строке поиска и замены. Проверка валидности бинарных данных в полях ввода не выполняется, по причине возможности использовать регулярное выражение, а в выходном результате - по причине замедления скорости.

При нахождении какого либо нелогичного или не интуитивного действия в поведении программы сообщайте на сайте в коментариях к программе.